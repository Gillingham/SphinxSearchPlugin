##########################
# WARNING: it is not original sphinx.conf - this file adopted to sphinx
# which installed by Vanilla Sphinx Search plugin.
##########################


#create an offset from the `vss_discussion`

source vss_main_comment
{
    type            = mysql
    sql_host        = localhost
    sql_user        = root
    sql_pass        = disney22
    sql_db          = mysql         #must be this for now
    sql_port        = 3306    #optional, default is 3306

    sql_query_pre   = SET NAMES utf8
    sql_query_pre   = REPLACE INTO GDN_pic.sph_counter SELECT 1, MAX((c.CommentID +1 + (SELECT MAX(d.DiscussionID) FROM GDN_pic.Discussion as d))) FROM GDN_pic.Comment as c
    sql_query       = SELECT  (c.CommentID +1 + (SELECT MAX(d.DiscussionID) FROM GDN_pic.Discussion as d)), c.CommentID as CommentID, 1 as TableID, c.DiscussionID as CommentDiscussionID, c.InsertUserID as CommentInsertUserID, c.UpdateUserID as CommentUpdateUserID, \
            c.Body as CommentBody, UNIX_TIMESTAMP(c.DateInserted) as CommentDateInserted, UNIX_TIMESTAMP(c.DateUpdated) as CommentDateUpdated,\
\
            cat.CategoryID as CatID, cat.ParentCategoryID as CatParentID, cat.Depth as CatDepth, cat.CountDiscussions as CatCountDiscussions,\
            cat.CountComments as CatCountComments, cat.Name as CatName, cat.UrlCode as CatUrlCode, cat.Description as CatDescription,\
            cat.LastCommentID as CatLastCommentID, cat.LastDiscussionID as CatLastDiscussionID,\
\
            0 as DiscussionName, d.Name as DiscussionNameAttr, d.CountComments as DiscussionCountComments, d.CountViews as DiscussionCountViews,\
            UNIX_TIMESTAMP(d.DateUpdated) as DiscussionDateUpdated, d.LastCommentUserID as DiscussionLastCommentUserID,\
            d.DiscussionID as DiscussionID, UNIX_TIMESTAMP(d.DateInserted) as DiscussionDateInserted,\
\
            u.Name as UserName, u.Photo as UserPhoto, u.UserID as UserID\
\
            FROM GDN_pic.Comment as c\
\
            INNER JOIN GDN_pic.Discussion as d ON c.DiscussionID = d.DiscussionID\
            INNER JOIN GDN_pic.Category as cat ON d.CategoryID = cat.CategoryID\
            INNER JOIN GDN_pic.User as u ON c.InsertUserID = u.UserID\
\
            WHERE (c.CommentID +1 + (SELECT MAX(d.DiscussionID) FROM GDN_pic.Discussion as d)) <=( SELECT max_doc_id FROM GDN_pic.sph_counter WHERE counter_id=1 )\


    # Field strings are BOTH indexed AND stored

    sql_field_string = CommentBody
    sql_field_string = DiscussionName
    sql_field_string = UserName

    sql_attr_string = DiscussionNameAttr


    # Attributes are NOT indexed, but stored

    sql_attr_timestamp =DiscussionDateInserted
    sql_attr_uint = DiscussionCountViews
    sql_attr_uint = DiscussionCountComments
    sql_attr_uint = DiscussionID
    sql_attr_uint = CommentID
    sql_attr_uint = TableID        #distinguishes between a discussion/comment



    sql_attr_timestamp = CommentDateInserted
    sql_attr_uint = CatID
    sql_attr_string = CatName
    sql_attr_string = CatUrlCode

    sql_attr_string = UserPhoto
    sql_attr_uint = UserID

}

source vss_delta_comment : vss_main_comment
{

    sql_query_pre = SET NAMES utf8

    sql_query   = SELECT  (c.CommentID +1 + (SELECT MAX(d.DiscussionID) FROM GDN_pic.Discussion as d)), c.CommentID as CommentID, 1 as TableID, c.DiscussionID as CommentDiscussionID, c.InsertUserID as CommentInsertUserID, c.UpdateUserID as CommentUpdateUserID, \
            c.Body as CommentBody, UNIX_TIMESTAMP(c.DateInserted) as CommentDateInserted, UNIX_TIMESTAMP(c.DateUpdated) as CommentDateUpdated,\
\
            cat.CategoryID as CatID, cat.ParentCategoryID as CatParentID, cat.Depth as CatDepth, cat.CountDiscussions as CatCountDiscussions,\
            cat.CountComments as CatCountComments, cat.Name as CatName, cat.UrlCode as CatUrlCode, cat.Description as CatDescription,\
            cat.LastCommentID as CatLastCommentID, cat.LastDiscussionID as CatLastDiscussionID,\
\
            0 as DiscussionName, d.Name as DiscussionNameAttr, d.CountComments as DiscussionCountComments, d.CountViews as DiscussionCountViews,\
            UNIX_TIMESTAMP(d.DateUpdated) as DiscussionDateUpdated, d.LastCommentUserID as DiscussionLastCommentUserID,\
            d.DiscussionID as DiscussionID, UNIX_TIMESTAMP(d.DateInserted) as DiscussionDateInserted,\
\
            u.Name as UserName, u.Photo as UserPhoto, u.UserID as UserID\
            FROM GDN_pic.Comment as c\
            INNER JOIN GDN_pic.Discussion as d ON c.DiscussionID = d.DiscussionID\
            INNER JOIN GDN_pic.Category as cat ON d.CategoryID = cat.CategoryID\
            INNER JOIN GDN_pic.User as u ON c.InsertUserID = u.UserID\
\
            WHERE (c.CommentID +1 + (SELECT MAX(d.DiscussionID) FROM GDN_pic.Discussion as d)) > (SELECT max_doc_id FROM GDN_pic.sph_counter WHERE counter_id=1)\

}

#this source selects the discussion body  and its related info, exactly like the `vss_comments` does.
#the discussion body is refered to as a comment to fit with the rest of the naming scheme
#yes, there are duplicate attributes stored, but the two sources MUST match columns(see MYSQL UNION)

source vss_main_discussion
{
    type            = mysql
    sql_host        = localhost
    sql_user        = root
    sql_pass        = disney22
    sql_db          = mysql         #must be this for now
    sql_port        = 3306    #optional, default is 3306

    sql_query_pre   = SET NAMES utf8
    sql_query_pre   = REPLACE INTO GDN_pic.sph_counter SELECT 2, (1 + (SELECT MAX(d.DiscussionID) FROM GDN_pic.Discussion as d)) FROM GDN_pic.Discussion as d
    sql_query       = SELECT  d.DiscussionID as CommentID, d.DiscussionID as CommentID, 2 as TableID, d.DiscussionID as CommentDiscussionID, d.InsertUserID as CommentInsertUserID, d.UpdateUserID as CommentUpdateUserID, \
            d.Body as CommentBody, UNIX_TIMESTAMP(d.DateInserted) as CommentDateInserted, UNIX_TIMESTAMP(d.DateUpdated) as CommentDateUpdated,\
\
            cat.CategoryID as CatID, cat.ParentCategoryID as CatParentID, cat.Depth as CatDepth, cat.CountDiscussions as CatCountDiscussions,\
            cat.CountComments as CatCountComments, cat.Name as CatName, cat.UrlCode as CatUrlCode, cat.Description as CatDescription,\
            cat.LastCommentID as CatLastCommentID, cat.LastDiscussionID as CatLastDiscussionID,\
\
            d.Name as DiscussionName, d.Name as DiscussionNameAttr,\
            d.CountComments as DiscussionCountComments, d.CountViews as DiscussionCountViews, UNIX_TIMESTAMP(d.DateUpdated) as DiscussionDateUpdated, d.LastCommentUserID as DiscussionLastCommentUserID,\
            d.DiscussionID as DiscussionID, UNIX_TIMESTAMP(d.DateInserted) as DiscussionDateInserted,\
\
            u.Name as UserName, u.Photo as UserPhoto, u.UserID as UserID\
            FROM GDN_pic.Discussion as d\
            INNER JOIN GDN_pic.Category as cat ON d.CategoryID = cat.CategoryID\
            INNER JOIN GDN_pic.User as u ON d.InsertUserID = u.UserID\
            WHERE (1 + (SELECT MAX(d.DiscussionID) FROM GDN_pic.Discussion as d)) <= (SELECT max_doc_id FROM GDN_pic.sph_counter WHERE counter_id=2)\

    # Field strings are BOTH indexed AND stored

    sql_field_string = CommentBody
    sql_field_string = DiscussionName
    sql_field_string = UserName

    sql_attr_string = DiscussionNameAttr

    # Attributes are NOT indexed, but stored

    sql_attr_timestamp =DiscussionDateInserted
    sql_attr_uint = DiscussionCountViews
    sql_attr_uint = DiscussionCountComments
    sql_attr_uint = DiscussionID
    sql_attr_uint = CommentID
    sql_attr_uint = TableID	#distinguishes between a discussion/comment



    sql_attr_timestamp = CommentDateInserted
    sql_attr_uint = CatID
    sql_attr_string = CatName
    sql_attr_string = CatUrlCode

    sql_attr_string = UserPhoto
    sql_attr_uint = UserID



}
source vss_delta_discussion : vss_main_discussion
{
    sql_query_pre = SET NAMES utf8
    sql_query = SELECT  d.DiscussionID as CommentID, d.DiscussionID as CommentID, 2 as TableID, d.DiscussionID as CommentDiscussionID, d.InsertUserID as CommentInsertUserID, d.UpdateUserID as CommentUpdateUserID, \
            d.Body as CommentBody, UNIX_TIMESTAMP(d.DateInserted) as CommentDateInserted, UNIX_TIMESTAMP(d.DateUpdated) as CommentDateUpdated,\
\
            cat.CategoryID as CatID, cat.ParentCategoryID as CatParentID, cat.Depth as CatDepth, cat.CountDiscussions as CatCountDiscussions,\
            cat.CountComments as CatCountComments, cat.Name as CatName, cat.UrlCode as CatUrlCode, cat.Description as CatDescription,\
            cat.LastCommentID as CatLastCommentID, cat.LastDiscussionID as CatLastDiscussionID,\
\
            d.Name as DiscussionName, d.Name as DiscussionNameAttr,\
            d.CountComments as DiscussionCountComments, d.CountViews as DiscussionCountViews, UNIX_TIMESTAMP(d.DateUpdated) as DiscussionDateUpdated, d.LastCommentUserID as DiscussionLastCommentUserID,\
            d.DiscussionID as DiscussionID, UNIX_TIMESTAMP(d.DateInserted) as DiscussionDateInserted,\
\
            u.Name as UserName, u.Photo as UserPhoto, u.UserID as UserID\
            FROM GDN_pic.Discussion as d\
            INNER JOIN GDN_pic.Category as cat ON d.CategoryID = cat.CategoryID\
            INNER JOIN GDN_pic.User as u ON d.InsertUserID = u.UserID\
			WHERE (0 + (SELECT MAX(d.DiscussionID) FROM GDN_pic.Discussion as d)) > (SELECT max_doc_id FROM GDN_pic.sph_counter WHERE counter_id=2)\

}

 index vss_main
{
    source          = vss_main_comment
    source          = vss_main_discussion
    path            = /srv/http/mcuhq/vanilla/plugins/SphinxSearch/install/var/data/vss_main
    docinfo         = extern
    charset_type    = utf8


    min_infix_len = 0
    min_word_len = 3
    min_stemming_len = 1
    morphology = stem_en
    enable_star = 0
    #stopwords = /etc/sphinx/stopwords.txt

}
index vss_delta : vss_main
{
    source          = vss_delta_comment
    source          = vss_delta_discussion
    path            = /srv/http/mcuhq/vanilla/plugins/SphinxSearch/install/var/data/vss_delta
}


index vanilla
{
    type            =  distributed
    local           =  vss_main
    local           =  vss_delta
}




indexer
{
    mem_limit       = 32
}

searchd
{
    port            = 9312
    log             = /srv/http/mcuhq/vanilla/plugins/SphinxSearch/install/var/lib/sphinx/log/search.log
    query_log       = /srv/http/mcuhq/vanilla/plugins/SphinxSearch/install/var/log/query.log
    read_timeout    = 5
    max_children    = 30
    pid_file        = /srv/http/mcuhq/vanilla/plugins/SphinxSearch/install/var/lib/sphinx/log/search.pid
    max_matches     = 1000

    compat_sphinxql_magics = 0 # the future is now
}

# --eof--